#!/usr/bin/env bash

# Init array of hostnames
declare -a HOSTNAMES
declare -a HOSTNAMESIPS
declare -a PREVIOUSIPS

# Autofilled Variables (do not change)
export vPWD=$(pwd)
export vPATH=$(echo $PATH)
export vVER=$(cat .ufw-autowhitelist.version)

timestamp() {
  echo -n "[$(date +"%Y-%m-%d %H-%M-%S")] "
}

if test -f ".ufw-autowhitelist.config"; then
  source .ufw-autowhitelist.config
else
  timestamp ; echo ".ufw-autowhitelist.config does not exist, please read the README.md!"
  timestamp ; echo ""
  exit
fi

timestamp ; echo ""
timestamp ; echo "ufw-autowhitelist ${vVER}"
timestamp ; echo ""

vHOSTNAMESLEN=${#HOSTNAMES[@]}
for (( j=0; j<vHOSTNAMESLEN; j++ ));
do
	declare -a HOSTNAMESIPS+=($(getent ahostsv4 ${HOST0} | awk 'NR>=0 && NR<=1 { print $1 }'))
	timestamp ; echo "Host ${j}	[${HOSTNAMES[$j]}] [${HOSTNAMESIPS[$j]}]"
done

timestamp ; echo ""

while read var; do
	declare -a PREVIOUSIPS+=("${var}")
done < ../etc/previous_ips

# debug only
timestamp ; echo ${PREVIOUSIPS[*]}

if [[ -z "../etc/previous_ips" ]] ; then
	truncate --size=0 ../etc/previous_ips
else
	touch ../etc/previous_ips
fi

for i in "${HOSTNAMESIPS[@]}"
do
	echo "$i"
done >> ../etc/previous_ips




# Clear ENV vars for security
source .ufw-autowhitelist.config.clear

exit ;

#vHOSTNAMESLEN=${#HOSTNAMES[@]}
#for (( j=0; j<vHOSTNAMESLEN; j++ ));
#do
#	 timestamp ; echo "Host ${j}	[${HOSTNAMES[$j]}] [${HOSTNAMESIPS[$j]}]"
#done



# Clear variables
export vHOST=""

export host0_curr_ip=$(cat ../etc/host0_current_ip)
export host1_curr_ip=$(cat ../etc/host1_current_ip)
export host2_curr_ip=$(cat ../etc/host2_current_ip)




export HOST0_IP_ADDR=$(echo "${HOST0_IP_ADDR}" | xargs)
export HOST1_IP_ADDR=$(echo "${HOST1_IP_ADDR}" | xargs)
export HOST2_IP_ADDR=$(echo "${HOST2_IP_ADDR}" | xargs)

export host0_curr_ip=$(echo "${host0_curr_ip}" | xargs)
export host1_curr_ip=$(echo "${host1_curr_ip}" | xargs)
export host2_curr_ip=$(echo "${host2_curr_ip}" | xargs)




echo "  HOST: ${HOST0}"
echo "NEW_IP: ${HOST0_IP_ADDR}"
echo "CUR_IP: ${host0_curr_ip}"
echo ""

echo "  HOST: ${HOST1}"
echo "NEW_IP: ${HOST1_IP_ADDR}"
echo "CUR_IP: ${host1_curr_ip}"
echo ""

echo "  HOST: ${HOST2}"
echo "NEW_IP: ${HOST2_IP_ADDR}"
echo "CUR_IP: ${host2_curr_ip}"
echo ""

echo "Updating CSF"

if [ "$HOST0_IP_ADDR" == "$host0_curr_ip" ]; then
	echo "H0 IP's are same, not updating..."
else
	echo "H0 IP's are different, updating..."
	ufw delete allow from ${host0_curr_ip}
	ufw allow from $HOST0_IP_ADDR
	echo ${HOST0_IP_ADDR} > ../etc/host0_current_ip
fi

if [ "$HOST1_IP_ADDR" == "$host1_curr_ip" ]; then
        echo "H1 IP's are same, not updating..."
else
        echo "H1 IP's are different, updating..."
        ufw delete allow from ${host1_curr_ip}
        ufw allow from $HOST1_IP_ADDR
        echo ${HOST1_IP_ADDR} > ../etc/host1_current_ip
fi

if [ "$HOST2_IP_ADDR" == "$host2_curr_ip" ]; then
        echo "H2 IP's are same, not updating..."
else
        echo "H2 IP's are different, updating..."
        ufw delete allow from ${host2_curr_ip}
        ufw allow from $HOST2_IP_ADDR
        echo ${HOST2_IP_ADDR} > ../etc/host2_current_ip
fi

echo ""
echo "DONE!"
echo ""
echo ""
