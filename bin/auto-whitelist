#!/usr/bin/env bash

# Init array of hostnames
declare -n HOSTNAMES=()

# Autofilled Variables (do not change)
export vPWD=$(pwd)
export vPATH=$(echo $PATH)
export vVER=$(cat .ufw-autowhitelist.version)

timestamp() {
  echo -n "[$(date +"%Y-%m-%d %H-%M-%S")] "
}

if test -f ".ufw-autowhitelist.config"; then
  source .ufw-autowhitelist.config
else
  timestamp ; echo ".ufw-autowhitelist.config does not exist, please read the README.md!"
  timestamp ; echo ""
  exit
fi

timestamp ; echo ""
timestamp ; echo "crypto-autosend ${vVER}"
timestamp ; echo ""
#timestamp ; echo "host                [$vHOST]"
echo Num items: ${#field[@]}
echo Data: ${field[@]}
timestamp ; echo ""



exit ;




echo ""
echo "Auto IP Whitelist"
echo ""

export HOST0=cato0.easyx.cc
export HOST1=cato1.easyx.cc
export HOST2=usnj0.easyx.cc

# Clear variables
export vHOST=""

export HOST0_IP_ADDR=$(getent ahostsv4 ${HOST0} | awk 'NR>=0 && NR<=1 { print $1 }')
export HOST1_IP_ADDR=$(getent ahostsv4 ${HOST1} | awk 'NR>=0 && NR<=1 { print $1 }')
export HOST2_IP_ADDR=$(getent ahostsv4 ${HOST2} | awk 'NR>=0 && NR<=1 { print $1 }')

export host0_curr_ip=$(cat ../etc/host0_current_ip)
export host1_curr_ip=$(cat ../etc/host1_current_ip)
export host2_curr_ip=$(cat ../etc/host2_current_ip)

export HOST0_IP_ADDR=$(echo "${HOST0_IP_ADDR}" | xargs)
export HOST1_IP_ADDR=$(echo "${HOST1_IP_ADDR}" | xargs)
export HOST2_IP_ADDR=$(echo "${HOST2_IP_ADDR}" | xargs)

export host0_curr_ip=$(echo "${host0_curr_ip}" | xargs)
export host1_curr_ip=$(echo "${host1_curr_ip}" | xargs)
export host2_curr_ip=$(echo "${host2_curr_ip}" | xargs)

echo "  HOST: ${HOST0}"
echo "NEW_IP: ${HOST0_IP_ADDR}"
echo "CUR_IP: ${host0_curr_ip}"
echo ""

echo "  HOST: ${HOST1}"
echo "NEW_IP: ${HOST1_IP_ADDR}"
echo "CUR_IP: ${host1_curr_ip}"
echo ""

echo "  HOST: ${HOST2}"
echo "NEW_IP: ${HOST2_IP_ADDR}"
echo "CUR_IP: ${host2_curr_ip}"
echo ""

echo "Updating CSF"

if [ "$HOST0_IP_ADDR" == "$host0_curr_ip" ]; then
	echo "H0 IP's are same, not updating..."
else
	echo "H0 IP's are different, updating..."
	ufw delete allow from ${host0_curr_ip}
	ufw allow from $HOST0_IP_ADDR
	echo ${HOST0_IP_ADDR} > ../etc/host0_current_ip
fi

if [ "$HOST1_IP_ADDR" == "$host1_curr_ip" ]; then
        echo "H1 IP's are same, not updating..."
else
        echo "H1 IP's are different, updating..."
        ufw delete allow from ${host1_curr_ip}
        ufw allow from $HOST1_IP_ADDR
        echo ${HOST1_IP_ADDR} > ../etc/host1_current_ip
fi

if [ "$HOST2_IP_ADDR" == "$host2_curr_ip" ]; then
        echo "H2 IP's are same, not updating..."
else
        echo "H2 IP's are different, updating..."
        ufw delete allow from ${host2_curr_ip}
        ufw allow from $HOST2_IP_ADDR
        echo ${HOST2_IP_ADDR} > ../etc/host2_current_ip
fi

echo ""
echo "DONE!"
echo ""
echo ""
