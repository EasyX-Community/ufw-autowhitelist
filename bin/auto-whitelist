#!/usr/bin/env bash

echo ""
echo "Auto IP Whitelist"
echo ""

vPWD=$(pwd)
echo "${vPWD}"

export HOST0=cato0.easyx.cc
export HOST1=cato1.easyx.cc
export HOST2=usnj0.easyx.cc

export HOST0_IP_ADDR=$(getent hosts ${HOST0} | awk '{print $1}')
export HOST1_IP_ADDR=$(getent hosts ${HOST1} | awk '{print $1}')
export HOST2_IP_ADDR=$(getent hosts ${HOST2} | awk '{print $1}')

export host0_curr_ip=$(cat ../etc/host0_current_ip)
export host1_curr_ip=$(cat ../etc/host1_current_ip)
export host2_curr_ip=$(cat ../etc/host2_current_ip)

export HOST0_IP_ADDR=$(echo "${HOST0_IP_ADDR}" | xargs)
export HOST1_IP_ADDR=$(echo "${HOST1_IP_ADDR}" | xargs)
export HOST2_IP_ADDR=$(echo "${HOST2_IP_ADDR}" | xargs)

export host0_curr_ip=$(echo "${host0_curr_ip}" | xargs)
export host1_curr_ip=$(echo "${host1_curr_ip}" | xargs)
export host2_curr_ip=$(echo "${host2_curr_ip}" | xargs)

echo "  HOST: ${HOST0}"
echo "NEW_IP: ${HOST0_IP_ADDR}"
echo "CUR_IP: ${host0_curr_ip}"
echo ""

echo "  HOST: ${HOST1}"
echo "NEW_IP: ${HOST1_IP_ADDR}"
echo "CUR_IP: ${host1_curr_ip}"
echo ""

echo "  HOST: ${HOST2}"
echo "NEW_IP: ${HOST2_IP_ADDR}"
echo "CUR_IP: ${host2_curr_ip}"
echo ""

echo "Updating CSF"

if [ "$HOST0_IP_ADDR" == "$host0_curr_ip" ]; then
	echo "H0 IP's are same, not updating..."
else
	echo "H0 IP's are different, updating..."
	ufw delete allow from ${host0_curr_ip}
	ufw allow from $HOST0_IP_ADDR
	echo ${HOST0_IP_ADDR} > ../etc/host0_current_ip
fi

if [ "$HOST1_IP_ADDR" == "$host1_curr_ip" ]; then
        echo "H1 IP's are same, not updating..."
else
        echo "H1 IP's are different, updating..."
        ufw delete allow from ${host1_curr_ip}
        ufw allow from $HOST1_IP_ADDR
        echo ${HOST1_IP_ADDR} > ../etc/host1_current_ip
fi

if [ "$HOST2_IP_ADDR" == "$host2_curr_ip" ]; then
        echo "H2 IP's are same, not updating..."
else
        echo "H2 IP's are different, updating..."
        ufw delete allow from ${host2_curr_ip}
        ufw allow from $HOST2_IP_ADDR
        echo ${HOST2_IP_ADDR} > ../etc/host2_current_ip
fi

echo ""
echo "DONE!"
echo ""
echo ""
